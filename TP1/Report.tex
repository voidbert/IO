\documentclass[12pt, a4paper, titlepage]{article}

\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[portuguese]{babel}
\usepackage{cite}
\usepackage{enumerate}
\usepackage{float}
\usepackage[a4paper, margin=2cm]{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{lscape}
\usepackage{setspace}
\usepackage[dvipsnames]{xcolor}

\chardef\_=`_

\title{\textbf{
    Investigação Operacional -- Trabalho Prático I  \\
    \large Problema de Empacotamento a Uma Dimensão
}}
\author{
    \begin{tabular}{ll}
        Ana Carolina Penha Cerqueira       & A104188 \\
        Humberto Gil Azevedo Sampaio Gomes & A104348 \\
        Ivo Filipe Mendes Vieira           & A103999 \\
        José António Fernandes Alves Lopes & A104541 \\
        José Rodrigo Ferreira Matos        & A100612 \\
    \end{tabular}
}
\date{23 de março de 2024}

\begin{document}

\onehalfspacing
\setlength{\parskip}{\baselineskip}
\setlength{\parindent}{0pt}
\def\arraystretch{1.5}

\maketitle

\begin{abstract}
    Este trabalho prático de Investigação Operacional tem como objetivo a resolução de um problema
    de empacotamento a uma dimensão utilizando o modelo de "um-corte"{}, de Dyckhoff.
    \cite{dyckhoff} Em detalhe, procura-se a formulação do problema, a sua modelação, a sua
    resolução, e a validação do modelo construído. Para tornar o processo de modelação mais rápido e
    menos propício a erros, o nosso grupo implementou conceitos de metaprogramação ao escrever um
    \emph{script} Python que automaticamente gera o código LP do modelo.
\end{abstract}

\section{Dados do problema}

Como exigido pelo enunciado, os dados do problema a resolver são determinados em função do número de
aluno mais elevado de entre os integrantes do grupo. No caso, este é A104541, que corresponde ao
aluno José Lopes, e dá origem aos seguintes dados:

\begin{table}[H]
    \begin{center}
        \begin{tabular}{c|c}
            Capacidade & Quantidade de contentores \\
            \hline
            11          & Ilimitada                 \\
            10          & 5                         \\
            7           & 5
        \end{tabular}
    \end{center}
    \caption{Número de contentores de cada comprimento disponíveis.}
    \label{containers-data}
\end{table}

\begin{table}[H]
    \begin{center}
        \begin{tabular}{c|c}
            Comprimento & Quantidade de itens \\
            \hline
            1           & 0                    \\
            2           & 13                   \\
            3           & 0                    \\
            4           & 9                    \\
            5           & 5
        \end{tabular}
    \end{center}
    \caption{Número de itens de cada comprimento para empacotar.}
    \label{items-data}
\end{table}

A soma dos comprimentos dos itens a empacotar é dada por:

$$2 \times 13 + 4 \times 9 + 5 \times 5 = 87$$

\section{Formulação do problema}

Pretende-se resolver um problema de empacotamento a uma dimensão, i.e., pretende-se determinar como
se deve distribuir um conjunto de itens por contentores. É necessário ter em conta que deve ser
atribuído exatamente um contentor a cada item, ou seja, um dado item não pode estar em mais do que
um contentor, e não pode haver itens que não tenham um contentor associado. Ademais, a soma dos
comprimentos dos itens em qualquer contentor não pode ultrapassar a sua capacidade.

Neste problema em específico, estão disponíveis contentores de capacidades 11, 10 e 7, sendo que há
contentores e capacidade 11 em número ilimitado, enquanto que há apenas 5 contentores de cada uma
das outras capacidades (tabela \ref{containers-data}). Pretendem-se empacotar 13 itens de
comprimento 2, 9 itens de comprimento 4, e 5 itens de comprimento 5 (tabela \ref{items-data}). O
objetivo é minimizar a soma das capacidade dos contentores utilizados.

% TODO - Descrever modelo de Dyckhoff

\section{Modelo de "um-corte"{} para um problema genérico}

\subsection{Parâmetros e notação utilizada}

Antes de apresentar o modelo final adaptado ao nosso problema, apresentaremos a formulação
matemática do modelo de "um-corte"{} para um caso geral, complementando a descrição meramente
textual feita anteriormente. Alguns objetos matemáticos devem ser conhecidos antes da introdução da
função objetivo e das restrições existentes. Será seguida a mesma notação do artigo que definiu este
modelo. \cite{dyckhoff}

\begin{itemize}
    \item $S \subset \mathbb{\mathbb{Z}^+}$: conjunto dos comprimentos de \emph{stock}, no caso,
        as capacidades dos contentores;
    \item $D \subset \mathbb{\mathbb{Z}^+}$: conjunto dos comprimentos do pedido, no caso, os
        comprimentos dos
        itens;
    \item $R \subset \mathbb{\mathbb{Z}^+}$: conjunto de resíduos, definidos como comprimentos não
        inferiores ao menor dos itens, que podem ser obtidos através da aplicação de "um-cortes"{}
        sucessivos a partir de $S$ e $D$.
\end{itemize}

Neste modelo, são dados do problema os seguintes parâmetros:

\begin{itemize}
    \item $N_l \in \mathbb{Z}^+_0$, com $l \in (D \cup R) \setminus S$: número de itens a empacotar
        com o comprimento $l$ (quando $l \not \in D$, $N_l = 0$);
    \item $c_l \in \mathbb{R}$, com $l \in S$: custo de um contentor com comprimento $l$;
    \item $d_l \in \mathbb{Z}^+ \cup \{ \infty \}$, com $l \in S$: disponibilidade de um contentor
        de um dado tipo.
\end{itemize}

\subsection{Variáveis de decisão}

Como já explicado, as variáveis de decisão principais deste problema são da forma $y_{k, l}$, e o
seu valor representa o número de divisões de comprimentos $k$ em comprimentos menores, $l$ e
$k - l$. Algumas regras triviais aplicam-se aos valores de $k$ e $l$:

\begin{itemize}
    \item O número de cortes é inteiro e não negativo: $y_{k, l} \in \mathbb{Z}^+_0$;
    \item De um "um-corte"{} não podem resultar comprimentos maiores do que o comprimento cortado:
        $l < k$;
    \item De qualquer "um-corte"{}, um dos comprimentos produzidos deve ser o comprimento de um
        item: $l \in D$;
    \item Apenas se podem dividir capacidades de contentores ou de comprimentos obtidos através de
        cortes anteriores (resíduos): $k \in S \cup R$.
\end{itemize}

\subsection{Função objetivo}

Na nossa extensão ao modelo de Dyckhoff, são necessárias outras variáveis de decisão para a
linearização da função objetivo. Procura-se minimizar a soma dos custos dos contentores utilizados,
assegurando-se que o número de usos de um dado contentor não é negativo:

\begin{equation}
    \text{min: } \sum_{l \in S} c_l \cdot \max \left \{ 0,
        {\color{blue} \sum_{k \in C_l} y_{l,k}} -
        {\color{ForestGreen} \sum_{k \in B_l} y_{k + l, k}}
    \right \}
    \label{eq:objective}
\end{equation}

Na equação anterior, os conjuntos $B_l$ e $C_l$ assumem os seguintes valores:

\begin{equation}
    B_l = \left \{k \in D \mid k + l \in S \cup R \right \} \label{eq:Bl}
\end{equation}

\begin{equation}
    C_l = \left \{k \in D \mid k < l \right \} \label{eq:Cl}
\end{equation}

Tendo em conta as definições de $B_l$ e $C_l$, conclui-se que o somatório a {\color{blue} azul}
na função objetivo \eqref{eq:objective} representa o número de comprimentos $l$ consumidos, enquanto
que o somatório a {\color{ForestGreen} verde} representa o número de comprimentos $l$ produzidos
através de "um-cortes"{}.

A linearização desta função objetivo é um processo simples: para cada $l \in S$, considera-se uma
variável de decisão $m_l$, que representa o máximo entre $0$ e a diferença de somatórios. Sendo
assim, $m_l$ será superior ou igual a ambos estes valores, e a minimização da soma de todos os $m_l$
conduzirá a que cada uma destas variáveis assuma exatamente um dos valores ($0$ ou a diferença entre
somatórios), visto que solução ótima estará na fronteira de um poliedro convexo:

\begin{equation}
    \begin{split}
        \text{min: }      & \sum_{l \in S} c_l \cdot m_l \\
        \forall_{l \in S} & \begin{cases}
            m_l \geq 0, \\
            m_l \geq \sum_{k \in C_l} y_{l,k} - \sum_{k \in B_l} y_{k + l, k}
        \end{cases}
    \end{split}
    \label{eq:objective-expanded}
\end{equation}

\subsection{Restrições}

Ao contrário das restrições anteriores, existentes apenas para ser possível uma representação linear
do modelo, segue-se a apresentação das restrições impostas pelo contexto e dados do problema.

\subsubsection{Restrições de equilíbrio}

Estas restrições são definidas no artigo de Dyckhoff \cite{dyckhoff} e garantem dois aspetos:
produz-se o número de espaços suficientes para empacotar os itens necessários, e não se consomem
mais comprimentos em "um-cortes"{} do que os que são produzidos. Para cada comprimento desejado, ou
resíduo que não igual à capacidade de um contentor ($l \in (D \cup R) \setminus S$), tem-se a
seguinte restrição:

\begin{equation}
    {\color{red} \sum_{k \in A_l} y_{k, l}} +
    {\color{ForestGreen} \sum_{k \in B_l} y_{k + l, k}} -
    {\color{blue} \sum_{k \in C_l} y_{l, k}} \geq N_l
    \label{eq:balance-restriction}
\end{equation}

Os conjuntos $B_l$ e $C_l$ já foram definidos anteriormente, e a definição de $A_l$ segue-se abaixo:

\begin{equation}
    A_l =
    \begin{cases}
        \left \{ k \in S \cup R \mid k > l \right \}, & l \in D \\
        \varnothing, & l \not \in D
    \end{cases}
\end{equation}

Assim, os somatórios a {\color{red} vermelho} e {\color{ForestGreen} vede} representam o número de
espaços gerados com comprimento $l$, enquanto que o somatório a {\color{blue} azul} representa o
número desses espaços consumidos por "um-cortes"{} subsequentes. O balanço final de cortes não deve
ser inferior a $0$, e nos casos em que há itens a empacotar, $N_l$.

\subsubsection{Restrições de contentores}

Devido à disponibilidade de cada contentor, é necessário estabelecer restrições que garantam que o
número de contentores usado de cada tipo (já calculado na função objetivo) não ultrapasse a sua
disponibilidade. Para cada $l: d_l \not = \infty$, tem-se a seguinte restrição:

\begin{equation}
    {\color{blue} \sum_{k \in C_l} y_{l,k}} -
    {\color{ForestGreen} \sum_{k \in B_l} y_{k + l, k}} \leq d_l
    \label{eq:container-restriction}
\end{equation}

Apesar de denominarmos estas restrições "de contentores"{}, tal foi feito apenas para as distinguir
das do modelo original de Dyckhoff. No entanto, podemos provar que estas se tratam de meras
restrições de equilíbrio que consideram $N_l = -d_l$ (não se pode ultrapassar um dado consumo de
contentores):

\begin{equation}
    \begin{split}
        \nonumber
        {\color{blue} \sum_{k \in C_l} y_{l,k}} -
        {\color{ForestGreen} \sum_{k \in B_l} y_{k + l, k}} \leq d_l
        & \Leftrightarrow \\
        \nonumber
        {\color{red} 0} +
        {\color{ForestGreen} \sum_{k \in B_l} y_{k + l, k}} -
        {\color{blue} \sum_{k \in C_l} y_{l,k}} \geq - d_l
        & \Leftrightarrow_{\color{red} A = \varnothing} \\
        \nonumber
        {\color{red} \sum_{k \in A_l} y_{k, l}} +
        {\color{ForestGreen} \sum_{k \in B_l} y_{k + l, k}} -
        {\color{blue} \sum_{k \in C_l} y_{l,k}} \geq - d_l & = N_l
    \end{split}
\end{equation}

\section{Aplicação do modelo de "um-corte"{} ao nosso problema}

% TODO - escrever esta secção

\section{Metaprogramação}

A expansão dos vários sumatórios do modelo de "um-corte"{} é, devido à sua dimensão, difícil de ser
executada manualmente. O processo não só é demorado, como também propício a erros de cálculo
difíceis de diagnosticar: uma solução errada ou a ausência de solução no modelo final apenas indica
a existência de um erro, mas não a sua localização. Ademais, o processo laborioso de criação do
modelo teria de ser repetido caso os dados iniciais do problema sofressem alterações, uma ocorrência
constante no mundo real. Para endereçar este problema, desenvolvemos \emph{scripts} em Python que
geram o modelo LP automaticamente.

\subsection{Modelo de "um-corte"{}}

O nosso \emph{script} para a implementação deste modelo encontra-se em anexo (ver
\ref{code:one-cut}) e o seu funcionamento passo a passo é descrito abaixo.

\begin{enumerate}[\hspace{1cm} \bfseries 1.]
    \item Calcular o conjunto de resíduos ($R$), sucessivamente executando todos os cortes possíveis
        com base nas capacidades dos contentores e nos comprimentos dos itens.

    \item Gerar a função objetivo, em particular, a variação que não diminui o custo de uma solução
        caso tenham sobrado espaços com comprimentos no conjunto das capacidades dos contentores
        (ver equação \ref{eq:objective-expanded}).

    \item Gerar as restrições de equilíbrio, calculando os conjuntos e os sumatórios descritos em
        \eqref{eq:balance-restriction}.

    \item Gerar restrições a afirmar que o número de contentores de um dado tipo utilizados não pode
        ser superior à disponibilidade dessa capacidade de contentor (ver equação
        \ref{eq:container-restriction}).

    \item Restringir todas as variáveis de corte a valores inteiros.
\end{enumerate}

No nosso \emph{script}, a remoção de variáveis redundantes é feita no processo de simplificação de
adições, tanto na geração da função objetivo como das restrições:
$(y_{10, 2}) + (y_{10, 8} + y_{8, 4})$ será automaticamente transformada em $y_{10, 8} + y_{8, 4}$,
por exemplo.

\subsection{Modelo dos padrões de corte}

Inicialmente, o nosso grupo resolveu o problema de empacotamento proposto utilizando o modelo dos
padrões de corte, de modo a poder verificar a solução do modelo de "um-corte"{} quando este fosse
implementado. Também desenvolvemos um \emph{script} que gera o modelo de Gilmore e Gomory
automaticamente, cujo funcionamento passo a passo é descrito abaixo, e cujo código se encontra em
anexo (ver \ref{code:cutting-patterns}). Como o foco deste trabalho não é o modelo dos padrões de
corte, este não é descrito em detalhe, pelo que é recomendada a leitura do artigo que o definiu.
\cite{gilmore-and-gomory}

\begin{enumerate}[\hspace{1cm} \bfseries 1.]
    \item Calcular os padrões de corte para cada contentor, dado o comprimento de cada item a
        empacotar. Isto é implementado recursivamente: procura-se cortar um comprimento em duas
        partes menores, uma das quais é o comprimento de um item. Calculam-se os padrões de corte da
        outra parte, e usa-se esse resultado para construir os padrões de corte relativos ao
        comprimento total. Um comentário LP é gerado para enumerar todos os padrões de corte
        calculados.

    \item Gerar a função objetivo: conhecem-se todas as variáveis de decisão (padrões de corte),
        cujos coeficientes são as capacidades dos contentores a que estão associadas, dado que se
        pretende minimizar a soma das capacidades dos contentores utilizados.

    \item Calcular quanto cada padrão de corte permite empacotar de cada item, e usar essa
        informação para gerar restrições que obrigam a que pelo menos um dado número de cada item
        seja empacotado.

    \item Gerar restrições relativas ao número máximo de contentores de cada capacidade: a soma de
        todos os padrões de corte usados que envolvem contentores de uma capacidade não pode ser
        superior à disponibilidade desses contentores.

    \item Registar que todas as variáveis correspondentes a padrões de corte são inteiras.
\end{enumerate}

\section{Conclusão}

Ao longo do desenvolvimento deste trabalho, não só fomos capazes de resolver o problema proposto
com correção, como também obtivemos um profundo conhecimento de dois modelos para a resolução de
problemas de empacotamento a uma dimensão. Este conhecimento permitiu-nos implementar programas que
constroem estes modelos sem qualquer intervenção humana, tornando a sua aplicação mais simples em
problemas maiores e em contextos em que os dados estão em constante mudança, evitando o desperdício
de horas humanas em cálculos que facilmente podem ser executados por um computador.

% Isto é uma grande gambiarra, mas funciona para pôr a bibliografia como uma secção.
\section{Bibliografia}
\def\refname{}
\vspace{-1.5cm}
\begin{thebibliography}{9}
    \bibitem{dyckhoff}
    H. Dyckhoff, "A New Linear Programming Approach to the Cutting Stock Problem",
    \emph{Operations Research}, vol. 29, no. 6, Dec., pp. 1092-1104, 1981.
    \href{https://doi.org/10.1287/opre.29.6.1092}{doi: 10.1287/opre.29.6.1092}

    \bibitem{gilmore-and-gomory}
    P. Gilmore, and R. Gomory, "A Linear Programming Approach to the Cutting Stock Problem",
    \emph{Operations Research}, vol. 9, no. 6, Dec., pp. 849-859, 1961.
    \href{https://doi.org/10.1287/opre.9.6.849}{doi: 10.1287/opre.9.6.849}
\end{thebibliography}

\section{Anexos}

\lstdefinestyle{codestyle}{
    commentstyle=\color{teal},
    keywordstyle=\color{blue},
    numberstyle=\ttfamily\color{gray},
    stringstyle=\color{red},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=false,
    keepspaces=true,
    numbers=left,
    numbersep=10pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=4,
    xleftmargin=3em
}
\lstset{style=codestyle}

\begin{landscape}

    \subsection{\emph{Script} gerador do modelo de "um-corte"{}}
\label{code:one-cut}
\lstinputlisting[language=python]{dyckhoff.py}
\pagebreak

\subsection{\emph{Script} gerador do modelo de padrões de corte}
\label{code:cutting-patterns}
\lstinputlisting[language=python]{gilmore_gomory.py}

\end{landscape}

\end{document}
